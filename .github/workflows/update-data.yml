name: Update CSV from Google Sheet
on:
  workflow_dispatch:
  schedule:
    - cron: "0 6-21 * * *"  # 7-22 Uhr MEZ

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Verhindert H채nger
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Verbessert Git-History

      - name: Download Google Sheet as CSV
        run: |
          set -euo pipefail  # Stoppt bei Fehlern
          curl -L "https://docs.google.com/spreadsheets/d/1_shdcAB2-cR7D0nSyBSx1c6kU15-g9GvI9XbJK4HuGY/export?format=csv&gid=0" -o data.csv
          [ -s data.csv ] || (echo "CSV ist leer!" && exit 1)  # Pr체ft leere Dateien

      - name: Validate CSV Format
        run: |
          if ! head -1 data.csv | grep -q "Wert"; then  # Pr체ft Header
            echo "Fehler: Ung체ltiges CSV-Format"
            exit 1
          fi

      - name: Commit CSV
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update data.csv"
          files: data.csv
          add: "data.csv"  # Explizites Staging

      - name: Notify Failure
        if: failure()
        uses: actions/email-to-github@v1
        with:
          to: your@email.com
          subject: "Workflow-Fehler"

      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache
          key: ${{ runner.os }}-cache
